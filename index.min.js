var SITE=function(e){var t={storage:null,settingsHandler:null,domHandler:null,levelHandler:null,CONSTANTS:null,debuggerSystem:null,Class:{},Factories:{},Level:{},resizeCanvas:function(){t.domHandler.setCanvas3dResolution(t.settingsHandler.resolution.x,t.settingsHandler.resolution.y)},settingsClick:function(){t.domHandler.visible(t.domHandler.domElements.settingsMenu)?t.domHandler.hideSettingsMenu(!0):t.domHandler.hideSettingsMenu(!1)},isUndefined:function(e){return typeof e===t.CONSTANTS.UNDEFINED},getTargetYDistance:function(e,t,n){var i=(e-t.position.y)/n.y;return i},projectVector3:function(e,t,n){var i=BABYLON.Vector3.Project(e,BABYLON.Matrix.Identity(),t.activeCamera.getViewMatrix().multiply(t.activeCamera.getProjectionMatrix()),t.activeCamera.viewport.toGlobal(n.getRenderWidth(),n.getRenderHeight()));return i},unprojectVector3:function(e,t,n){var i=BABYLON.Vector3.Unproject(e,n.getRenderWidth(),n.getRenderHeight(),BABYLON.Matrix.Identity(),t.getViewMatrix(),t.getProjectionMatrix());return i},clamp:function(e,t,n){return e<t?t:e>n?n:e}},n={onLoad:function(){console.log("onload"),t.storage=new t.Class.StorageHandler,t.ua=new t.Class.UA,t.domHandler=new t.Class.DOMHandler,t.settingsHandler=new t.Class.SettingsHandler,t.debuggerSystem=new t.Class.Debugger,t.levelHandler=new t.Class.LevelHandler,window.addEventListener(t.CONSTANTS.RESIZEEVENT,function(){t.engine3d.engine.resize()}),t.levelHandler.loadLevel(t.Class.LevelHandler.LEVELS.LEVEL1)}};e={onLoad:n.onLoad};var i=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},a=e._unseal=e._unseal||function(){e._=t,e._seal=i,e._unseal=a};return e}(SITE||{});!function(e){GAME._unseal();var t=e._=e._||{};t.CONSTANTS={UNDEFINED:"undefined",DEBUG:"debug",RESIZEEVENT:"resize",TRUE_STRING:"true",FALSE_STRING:"false",STRING:"string",FUNCTION:"function",DECK_OWNERS:["GLOBAL_DECK","P1_DECK","P2_DECK"],PILE_OWNERS:["GLOBAL_PILE","P1_PILE","P2_PILE"],HALFPI:Math.PI/2,BOARD_NAME:"board",BOARD_WIDTH:330,BOARD_HEIGHT:220,BATTLE_AREA_WIDTH:230,BATTLE_AREA_HEIGHT:35,CAMERA_HEIGHT:175,FOV:1.5,CARD_WIDTH:16,CARD_HEIGHT:22,CARD_DEPTH:.5,CARD_HALFDEPTH:.5,LIGHT_HEIGHT:150,GLOBAL_DECK:{x:.1,z:.42},P1_DECK:{x:.85,z:.2},P2_DECK:{x:.85,z:.8},GLOBAL_PILE:{x:.1,z:.58},P1_PILE:{x:.92,z:.2},P2_PILE:{x:.92,z:.8},PORTRAIT_WIDTH:65,PORTRAIT_HEIGHT:45,PORTRAIT_DEPTH:.2,PORTRAIT_TYPE:"Portrait",BATTLE_AREA_TYPE:"BattleArea",TOKEN_TYPE:"Token",P1:"p1",P2:"p2"},GAME._seal();var n=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},i=e._unseal=e._unseal||function(){e._=t,e._seal=n,e._unseal=i}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Debugger=function(){this.printStack=[]},t.Class.Debugger.prototype.showAxis=function(e,t){var n=BABYLON.Mesh.CreateLines("axisX",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(e,0,0)],t);n.color=new BABYLON.Color3(1,0,0);var i=BABYLON.Mesh.CreateLines("axisY",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(0,e,0)],t);i.color=new BABYLON.Color3(0,1,0);var a=BABYLON.Mesh.CreateLines("axisZ",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(0,0,e)],t);a.color=new BABYLON.Color3(0,0,1)},t.Class.Debugger.prototype.tickFPS=function(){t.domHandler.domElements.fpsLabel.innerHTML=t.engine3d.engine.getFps()},t.Class.Debugger.prototype.enableDebug=function(e,t){console.log("Debugging Scene"),t?e.debugLayer.show():e.debugLayer.hide()},t.Class.Debugger.prototype.createDebugSphere=function(e,n){var i=BABYLON.Mesh.CreateSphere("Sphere",10,6,t.engine3d.scene);return i.position=e,i.material=new BABYLON.StandardMaterial("texture1",t.engine3d.scene),i.material.diffuseColor=n,i},t.Class.Debugger.prototype.what=function(e,n){if(typeof n===t.CONSTANTS.STRING)e.hasOwnProperty(n)&&console.log(e[n]);else for(var i=0;i<n.length;i++){var a=n[i].split(".");this.propertyPrint(e,a)}},t.Class.Debugger.prototype.propertyPrint=function(e,t){if(t.length<=1){if(e.hasOwnProperty(t[0])){this.printStack.push(t+":"+e[t[0]]+";");for(var n="",i=0;i<this.printStack.length;i++)n+=this.printStack[i];for(console.log(n);this.printStack.length>0;)this.printStack.pop()}}else this.printStack.push(t[0]+"."),this.propertyPrint(e[t.splice(0,1)],t)},t.Class.Debugger.prototype.printArrayProperties=function(e,t){var n=e.map(function(e){return e[t]});console.log(n)},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.UA=function(){this.pixelRatio=window.devicePixelRatio||1,this.viewport={width:window.innerWidth,height:window.innerHeight},this.screen={width:window.screen.availWidth*this.pixelRatio,height:window.screen.availHeight*this.pixelRatio},this.iPhone=/iPhone/i.test(navigator.userAgent),this.iPhone4=this.iPhone&&2==this.pixelRatio,this.iPad=/iPad/i.test(navigator.userAgent),this.android=/android/i.test(navigator.userAgent),this.winPhone=/Windows Phone/i.test(navigator.userAgent),this.uiwebview=/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent),this.safari_or_uiwebview=/(iPhone|iPod|iPad).*AppleWebKit/i.test(navigator.userAgent),this.iOS=this.iPhone||this.iPad,this.iOS6_tag=/OS 6_/i.test(navigator.userAgent),this.iOS6=(this.iPhone||this.iPad)&&this.iOS6_tag,this.iOSgt5=this.iOS&&parseInt(navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/)[1])>5,this.HTCONE=/HTC_One/i.test(navigator.userAgent),this.winPhone=/Windows Phone/i.test(navigator.userAgent),this.Kindle=/Silk/i.test(navigator.userAgent),this.touchDevice="ontouchstart"in window||window.navigator.msMaxTouchPoints,this.mobile=this.iOS||this.android||this.iOS6||this.winPhone||this.Kindle||/mobile/i.test(navigator.userAgent)},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.ActionHandler=function(e){this.game=e,this.dragActionCallback=null},t.Class.ActionHandler.prototype.makeStartDragCardAction=function(e){var n=function(){var e=arguments[0],n=e.mesh;n.position.y+=1,console.log("1st click card:"+n.name);var i=t.engine3d.scene;t.levelHandler.currLevel.startPos=new BABYLON.Vector2(i.pointerX,i.pointerY);var a=i.pick(i.pointerX,i.pointerY,function(e){return e===arguments[0]}.bind(null,e.mesh));a.hit&&(t.levelHandler.currLevel.meshSelected=a.pickedMesh),i.actionManager||(i.actionManager=new BABYLON.ActionManager(t.engine3d.scene)),this.dragActionCallback=this.makeExecuteDragAction(e),i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnEveryFrameTrigger,this.dragActionCallback))}.bind(this,e);return n},t.Class.ActionHandler.prototype.makeExecuteDragAction=function(e){var n=function(){var e=arguments[0],n=e.mesh,i=t.engine3d.engine,a=t.engine3d.scene,s=t.levelHandler.currLevel.startPos;if(s){var o=null;if(o=new BABYLON.Vector2(a.pointerX,a.pointerY)){var r=a.getProjectionMatrix(),l=a.getViewMatrix(),c=a.activeCamera.getWorldMatrix(),u=a.activeCamera.viewport.toGlobal(i.getRenderWidth(),i.getRenderHeight()),d=u.width,h=u.height,_=BABYLON.Vector3.Unproject(new BABYLON.Vector3(a.pointerX,a.pointerY,0),d,h,c,l,r),A=BABYLON.Vector3.Unproject(new BABYLON.Vector3(a.pointerX,a.pointerY,1),d,h,c,l,r),p=A.subtract(_),E=p.y+0;p.y=-p.z,p.z=E;var g=p.normalize(),m=t.getTargetYDistance(n.position.y,a.activeCamera,g),C=a.activeCamera.position.clone().add(g.scale(m));n.position=C,t.levelHandler.currLevel.startPos=o;var f=(t.projectVector3(n.position.clone(),a,i),e.mesh.position),T=a.activeCamera.position.clone(),N=f.clone().subtract(T),M=new BABYLON.Ray(f,N.normalize()),v=a.pickWithRay(M,function(e){return e.name===t.CONSTANTS.P1+t.CONSTANTS.BATTLE_AREA_TYPE}),S=a.pickWithRay(M,function(e){return e.name===t.CONSTANTS.P2+t.CONSTANTS.BATTLE_AREA_TYPE});v.hit?v.pickedMesh.material.diffuseColor=new BABYLON.Color3(0,.5,0):S.hit&&(S.pickedMesh.material.diffuseColor=new BABYLON.Color3(0,.5,0))}}}.bind(null,e);return n},t.Class.ActionHandler.prototype.makePickOutOnCardAction=function(e){var n=function(){console.log("pick out of card");for(var e=arguments[0],n=t.engine3d.scene,i=t.engine3d.engine,a=-1,s=0;s<n.actionManager.actions.length;s++)this.dragActionCallback===n.actionManager.actions[s].func&&(a=s);a>=0&&(console.log("removing found:"+a),console.log(n.actionManager.actions.length),n.actionManager.actions.splice(a,1),console.log(n.actionManager.actions.length)),e.mesh.position=e.originalPos.clone();t.projectVector3(e.mesh.position,n,i);t.levelHandler.currLevel.startPos=null,t.levelHandler.currLevel.meshSelected=null}.bind(this,e);return n},t.Class.ActionHandler.prototype.makePickUpOnCardAction=function(e){var n=function(){console.log("pick up on card");for(var e=arguments[0],n=t.engine3d.scene,i=t.engine3d.engine,a=-1,s=0;s<n.actionManager.actions.length;s++)this.dragActionCallback===n.actionManager.actions[s].func&&(a=s);a>=0&&(console.log("removing found:"+a),console.log(n.actionManager.actions.length),n.actionManager.actions.splice(a,1),console.log(n.actionManager.actions.length)),e.mesh.position=e.originalPos.clone();var o=(t.projectVector3(e.mesh.position,n,i),e.mesh.position),r=n.activeCamera.position.clone(),l=o.clone().subtract(r),c=new BABYLON.Ray(o,l.normalize()),u=n.pickWithRay(c,function(e){return e.name===t.CONSTANTS.P1+t.CONSTANTS.BATTLE_AREA_TYPE}),d=n.pickWithRay(c,function(e){return e.name===t.CONSTANTS.P2+t.CONSTANTS.BATTLE_AREA_TYPE});u.hit?u.pickedMesh.material.diffuseColor=new BABYLON.Color3(0,.5,0):d.hit&&(d.pickedMesh.material.diffuseColor=new BABYLON.Color3(0,.5,0)),t.levelHandler.currLevel.startPos=null,t.levelHandler.currLevel.meshSelected=null}.bind(this,e);return n},t.Class.ActionHandler.prototype.makeNameUpdateCallback=function(e){var n=function(){var e=arguments[0],n=e.mesh,i=t.engine3d.engine,a=t.engine3d.scene,s=(t.levelHandler.currLevel.startPos,a.getProjectionMatrix()),o=a.getViewMatrix(),r=a.activeCamera.getWorldMatrix(),l=a.activeCamera.viewport.toGlobal(i.getRenderWidth(),i.getRenderHeight()),c=l.width,u=l.height,d=BABYLON.Vector3.Unproject(new BABYLON.Vector3(a.pointerX,a.pointerY,0),c,u,r,o,s),h=BABYLON.Vector3.Unproject(new BABYLON.Vector3(a.pointerX,a.pointerY,1),c,u,r,o,s),_=h.subtract(d),A=_.y+0;_.y=-_.z,_.z=A;var p=_.normalize(),E=t.getTargetYDistance(n.position.y,a.activeCamera,p),g=(a.activeCamera.position.clone().add(p.scale(E)),t.projectVector3(n.position.clone(),a,i));e.t2d.x=g.x,e.t2d.y=i.getRenderHeight()-g.y}.bind(null,e);return n},t.Class.ActionHandler.prototype.attachScaleOnHover=function(e,t){var n=e.mesh,i=t.scale,a=t.condition,s=t.timing;n.actionManager.registerAction(new BABYLON.InterpolateValueAction({trigger:BABYLON.ActionManager.OnPointerOverTrigger,parameter:{usePreciseIntersection:!1}},n,"scaling",i,s,a))},t.Class.ActionHandler.prototype.attachScaleOutHover=function(e,t){var n=e.mesh,i=t.scale,a=t.condition,s=t.timing;n.actionManager.registerAction(new BABYLON.InterpolateValueAction({trigger:BABYLON.ActionManager.OnPointerOutTrigger,parameter:{usePreciseIntersection:!1}},e.mesh,"scaling",i,s,a))},t.Class.ActionHandler.prototype.attachNameUpdate=function(e){t.engine3d.scene.actionManager||(t.engine3d.scene.actionManager=new BABYLON.ActionManager(t.engine3d.scene));var n=this.makeNameUpdateCallback(e);t.engine3d.scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnEveryFrameTrigger,n))},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.AnimationHandler=function(e){this.game=e,this.anims=[]},t.Class.AnimationHandler.prototype.update=function(){for(var e=t.engine3d.engine.getDeltaTime()/1e3,n=0;n<this.anims.length;n++){var i=this.anims[n].obj;if(this.anims[n].started)if(this.anims[n].paused||this.anims[n].complete)this.remove(this.anims[n]);else{if(i.animating=!0,this.anims[n].delay>0){this.anims[n].delay-=e,this.anims[n].delay=this.anims[n].delay<0?0:this.anims[n].delay;continue}var a=this.anims[n].totalElapsed/this.anims[n].duration;a=a>1?1:a;var s=this.anims[n].easing(a);if(this.anims[n].type===t.Class.AnimationHandler.TYPE_ROTATION){var o=this.anims[n].delta.x*s,r=this.anims[n].delta.y*s,l=this.anims[n].delta.z*s,c=t.isUndefined(this.anims[n].value.x)?this.anims[n].startEuler.x:this.anims[n].start.x+o,u=t.isUndefined(this.anims[n].value.y)?this.anims[n].startEuler.y:this.anims[n].start.y+r,d=t.isUndefined(this.anims[n].value.z)?this.anims[n].startEuler.z:this.anims[n].start.z+l;this.anims[n].mesh.rotationQuaternion=BABYLON.Quaternion.RotationAlphaBetaGamma(d,c,u)}this.anims[n].type===t.Class.AnimationHandler.TYPE_TRANSLATION&&(this.anims[n].mesh.position.x=this.anims[n].start.x+this.anims[n].delta.x*s,this.anims[n].mesh.position.y=this.anims[n].start.y+this.anims[n].delta.y*s,this.anims[n].mesh.position.z=this.anims[n].start.z+this.anims[n].delta.z*s),a>=1&&(0!==this.anims[n].loopNum&&this.anims[n].loop?this.anims[n].loop==GAME.AnimationHandler.LOOP_REVERT||this.anims[n].loop==GAME.AnimationHandler.LOOP_REVERSE:(this.anims[n].mesh.computeWorldMatrix(!0),i.originalPos=this.anims[n].mesh.position.clone(),i.animating=!1,this.anims[n].complete=!0)),this.anims[n].totalElapsed+=e}}},t.Class.AnimationHandler.prototype.addAnim=function(e){this.anims.push(e)},t.Class.AnimationHandler.prototype.remove=function(e){this.anims.splice(this.anims.indexOf(e),1)},t.Class.AnimationHandler.prototype.start=function(e){var t=this.anims.indexOf(e);this.anims[t].started=!0,this.anims[t].complete=!1,this.anims[t].paused=!1,this.anims[t].totalElapsed=0},t.Class.AnimationHandler.prototype.pause=function(e){this.anims.push(e)},t.Class.AnimationHandler.TYPE_ROTATION=1,t.Class.AnimationHandler.TYPE_TRANSLATION=2,t.Class.AnimationHandler.TYPE_SCALING=3,t.Class.AnimationHandler.LOOP_REVERT=1,t.Class.AnimationHandler.LOOP_REVERSE=2,t.Class.AnimationHandler.EASE_NONE=function(e){return e},t.Class.AnimationHandler.QUADRATIC_EASEIN=function(e){return e*e},t.Class.AnimationHandler.QUADRATIC_EASEOUT=function(e){return-e*(e-2)},t.Class.AnimationHandler.QUADRATIC_EASEINOUT=function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},t.Class.AnimationHandler.CUBIC_EASEIN=function(e){return e*e*e},t.Class.AnimationHandler.CUBIC_EASEOUT=function(e){return--e*e*e+1},t.Class.AnimationHandler.CUBIC_EASEINOUT=function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},t.Class.AnimationHandler.QUARTIC_EASEIN=function(e){return e*e*e*e},t.Class.AnimationHandler.QUARTIC_EASEOUT=function(e){return-(--e*e*e*e-1)},t.Class.AnimationHandler.QUARTIC_EASEINOUT=function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},t.Class.AnimationHandler.QUINTIC_EASEIN=function(e){return e*e*e*e*e},t.Class.AnimationHandler.QUINTIC_EASEOUT=function(e){return(e-=1)*e*e*e*e+1},t.Class.AnimationHandler.QUINTIC_EASEINOUT=function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},t.Class.AnimationHandler.SINUSOIDAL_EASEIN=function(e){return-Math.cos(e*Math.PI/2)+1},t.Class.AnimationHandler.SINUSOIDAL_EASEOUT=function(e){return Math.sin(e*Math.PI/2)},t.Class.AnimationHandler.SINUSOIDAL_EASEINOUT=function(e){return-.5*(Math.cos(Math.PI*e)-1)},t.Class.AnimationHandler.EXPONENTIAL_EASEIN=function(e){return 0===e?0:Math.pow(2,10*(e-1))},t.Class.AnimationHandler.EXPONENTIAL_EASEOUT=function(e){return 1===e?1:-Math.pow(2,-10*e)+1},t.Class.AnimationHandler.EXPONENTIAL_EASEINOUT=function(e){return 0===e?0:1==e?1:(e*=2)<1?.5*Math.pow(2,10*(e-1)):.5*(-Math.pow(2,-10*(e-1))+2)},t.Class.AnimationHandler.CIRCULAR_EASEIN=function(e){return-(Math.sqrt(1-e*e)-1)},t.Class.AnimationHandler.CIRCULAR_EASEOUT=function(e){return Math.sqrt(1- --e*e)},t.Class.AnimationHandler.CIRCULAR_EASEINOUT=function(e){return(e/=.5)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},t.Class.AnimationHandler.ELASTIC_EASEIN=function(e){var t,n=.1,i=.4;return 0===e?0:1==e?1:(i||(i=.3),!n||n<1?(n=1,t=i/4):t=i/(2*Math.PI)*Math.asin(1/n),-(n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)))},t.Class.AnimationHandler.ELASTIC_EASEOUT=function(e){var t,n=.1,i=.4;return 0===e?0:1==e?1:(i||(i=.3),!n||n<1?(n=1,t=i/4):t=i/(2*Math.PI)*Math.asin(1/n),n*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/i)+1)},t.Class.AnimationHandler.ELASTIC_EASEINOUT=function(e){var t,n=.1,i=.4;return 0===e?0:1==e?1:(i||(i=.3),!n||n<1?(n=1,t=i/4):t=i/(2*Math.PI)*Math.asin(1/n),(e*=2)<1?-.5*(n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)):n*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*.5+1)},t.Class.AnimationHandler.BACK_EASEIN=function(e){var t=1.70158;return e*e*((t+1)*e-t)},t.Class.AnimationHandler.BACK_EASEOUT=function(e){var t=1.70158;return(e-=1)*e*((t+1)*e+t)+1},t.Class.AnimationHandler.BACK_EASEINOUT=function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)},t.Class.AnimationHandler.BOUNCE_EASEIN=function(e){return 1-this.BOUNCE_EASEOUT(1-e)},t.Class.AnimationHandler.BOUNCE_EASEOUT=function(e){return(e/=1)<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},t.Class.AnimationHandler.BOUNCE_EASEINOUT=function(e){return e<.5?.5*this.BOUNCE_EASEIN(2*e):.5*this.BOUNCE_EASEOUT(2*e-1)+.5},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.AudioHandler=function(){},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.CreationHandler=function(e){this.game=e},t.Class.CreationHandler.prototype.createCard=function(e,n,i){var a=e.name;e.t2d||(e.t2d=new BABYLON.Text2D(a,{parent:t.engine3d.canvas2d,id:"text",x:0,y:0,position:new BABYLON.Vector2(0,0),fontName:"20pt Arial"}));var s=[];s[0]=new BABYLON.Color4(1,1,0,1),s[1]=new BABYLON.Color4(0,1,0,1),e.mesh=BABYLON.MeshBuilder.CreateBox(e.name,{width:t.CONSTANTS.CARD_WIDTH,height:t.CONSTANTS.CARD_HEIGHT,depth:t.CONSTANTS.CARD_DEPTH,updateable:!0,faceColors:s},t.engine3d.scene),e.mesh.material=new BABYLON.StandardMaterial("texture1",t.engine3d.scene),e.mesh.showBoundingBox=!1,e.mesh.setEnabled(!0),e.mesh.position=n,e.mesh.rotation.x=t.CONSTANTS.HALFPI},t.Class.CreationHandler.prototype.createDragAction=function(e){var n=this.game.actionHandler.makeStartDragCardAction(e),i=e.mesh;if(t.isUndefined(i.actionManager))throw"Mesh action manager is undefined:"+i.name;i.isPickable=!0;var a=new BABYLON.ValueCondition(i.actionManager,e,"animating",(!1),BABYLON.ValueCondition.IsEqual);i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickDownTrigger,n),a);var s=this.game.actionHandler.makePickUpOnCardAction(e);i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger,s),a);var o=this.game.actionHandler.makePickOutOnCardAction(e);i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickOutTrigger,o),a)},t.Class.CreationHandler.prototype.createBoard=function(e){var n=t.Factories.entityFactory.createBoard(e,t.engine3d.scene,{width:t.CONSTANTS.BOARD_WIDTH,height:t.CONSTANTS.BOARD_HEIGHT,subdivisions:1});return n},t.Class.CreationHandler.prototype.createCamera=function(e){var n=t.Factories.cameraFactory.createCamera(e,t.engine3d.scene,t.engine3d.canvas,{position:new BABYLON.Vector3(0,t.CONSTANTS.CAMERA_HEIGHT,0),fov:t.CONSTANTS.FOV});return n},t.Class.CreationHandler.prototype.createLight=function(e){var n=t.Factories.lightFactory.createLight(e,t.engine3d.scene,{position:new BABYLON.Vector3(0,t.CONSTANTS.LIGHT_HEIGHT,0)});return n},t.Class.CreationHandler.prototype.createDecks=function(e,n,i){for(var a=0;a<e.length;a++){var s=e[a],o=Math.floor(t.CONSTANTS[s].x*t.CONSTANTS.BOARD_WIDTH-t.CONSTANTS.BOARD_WIDTH/2),r=Math.floor(t.CONSTANTS[s].z*t.CONSTANTS.BOARD_HEIGHT-t.CONSTANTS.BOARD_HEIGHT/2),l=[];l[0]=new BABYLON.Color4(1,1,0,1),l[1]=new BABYLON.Color4(0,1,0,1),n[a]=new t.Class.Deck(s,t.engine3d.scene,{owner:i.owner,position:new BABYLON.Vector3(o,t.CONSTANTS.CARD_HALFDEPTH,r),mesh_settings:{width:t.CONSTANTS.CARD_WIDTH,height:t.CONSTANTS.CARD_HEIGHT,depth:t.CONSTANTS.CARD_DEPTH,updateable:!0,faceColors:l}}),n[a].mesh.rotation.x=i[a].rotations.x,n[a].mesh.rotation.y=i[a].rotations.y,n[a].mesh.rotation.z=i[a].rotations.z}},t.Class.CreationHandler.prototype.createPiles=function(e,n,i){for(var a=0;a<e.length;a++){var s=e[a],o=Math.floor(t.CONSTANTS[s].x*t.CONSTANTS.BOARD_WIDTH-t.CONSTANTS.BOARD_WIDTH/2),r=Math.floor(t.CONSTANTS[s].z*t.CONSTANTS.BOARD_HEIGHT-t.CONSTANTS.BOARD_HEIGHT/2);n[a]=new t.Class.Deck(s,t.engine3d.scene,{position:new BABYLON.Vector3(o,t.CONSTANTS.CARD_HALFDEPTH,r),mesh_settings:{width:t.CONSTANTS.CARD_WIDTH,height:t.CONSTANTS.CARD_HEIGHT,depth:t.CONSTANTS.CARD_DEPTH,updateable:!0}}),n[a].mesh.rotate(BABYLON.Axis.X,i[a].rotations.x,BABYLON.Space.LOCAL),n[a].mesh.rotate(BABYLON.Axis.Y,i[a].rotations.y,BABYLON.Space.LOCAL),n[a].mesh.rotate(BABYLON.Axis.Z,i[a].rotations.z,BABYLON.Space.LOCAL)}},t.Class.CreationHandler.prototype.createPlayers=function(e){for(var n=[],i=0;i<e.length;i++){var a="p"+(i+1);n.push(new t.Class.Player(a,e[i]))}return n},t.Class.CreationHandler.prototype.createHands=function(e){for(var n=[new BABYLON.Vector3((-40),70,(-39)),new BABYLON.Vector3((-40),70,39)],i=[!1,!0],a=0;a<e.length;a++)e[a].hand=new t.Class.Hand("p"+(a+1)+"Hand",n[a],i[a])},t.Class.CreationHandler.prototype.createDrawCardAnimation=function(e,n,i){var a=[];if(!t.isUndefined(i)){var s=new t.Class.Anim(e,.55,{type:t.Class.AnimationHandler.TYPE_ROTATION,value:i,space:BABYLON.Space.LOCAL});this.game.animationHandler.addAnim(s),a.push(s)}var o=new t.Class.Anim(e,.6,{type:t.Class.AnimationHandler.TYPE_TRANSLATION,value:n,space:BABYLON.Space.WORLD});return this.game.animationHandler.addAnim(o),a.push(o),a},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.DeckHandler=function(e){this.game=e},t.Class.DeckHandler.prototype.shuffle=function(e){for(var t=e.cards.length;t;){var n=Math.floor(Math.random()*t--),i=e.cards[t];e.cards[t]=e.cards[n],e.cards[n]=i}},t.Class.DeckHandler.prototype.add=function(e,n){for(var i in n)for(var a=0;a<n[i];a++){var s=t.Factories.entityFactory.createCard(i,e.owner);e.cards.push(s),e.cards.length>1&&(e.mesh.scaling.z+=t.CONSTANTS.CARD_DEPTH)}this.resize(e)},t.Class.DeckHandler.prototype.resize=function(e){var t=e.mesh.getBoundingInfo().boundingBox.vectorsWorld,n=0,i=4,a=t[n].subtract(t[n+i]).length();e.cards.length;e.mesh.position.y=0,e.mesh.position.y+=a/2*e.mesh.scaling.z,e.mesh.setEnabled(!0)},t.Class.DeckHandler.prototype.draw=function(e){var n=e.cards.pop();return e.cards.length>1&&(e.mesh.scaling.z-=t.CONSTANTS.CARD_DEPTH),this.resize(e),e.cards.length<=0&&e.mesh.setEnabled(!1),n},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.DOMHandler=function(){this.guiIds={CANVAS_3D_ID:"canvas3d",SETTINGS_MAIN_BUTTON_ID:"settingsButton",SETTINGS_MENU_ID:"settingsMenu",RES_X_ID:"resX",RES_Y_ID:"resY",FPS_LABEL_ID:"fpsLabel",RENDER_WIDTH:"renderWidth",RENDER_HEIGHT:"renderHeight",INNER_WIDTH:"innerWidth",INNER_HEIGHT:"innerHeight"},this.VISIBLE="visible",this.HIDDEN="hidden",this.domElements={canvas3d:document.getElementById(this.guiIds.CANVAS_3D_ID),settingsMainButton:document.getElementById(this.guiIds.SETTINGS_MAIN_BUTTON_ID),settingsMenu:document.getElementById(this.guiIds.SETTINGS_MENU_ID),resX:document.getElementById(this.guiIds.RES_X_ID),resY:document.getElementById(this.guiIds.RES_Y_ID),fpsLabel:document.getElementById(this.guiIds.FPS_LABEL_ID),renderWidth:document.getElementById(this.guiIds.RENDER_WIDTH),renderHeight:document.getElementById(this.guiIds.RENDER_HEIGHT),innerWidth:document.getElementById(this.guiIds.INNER_WIDTH),innerHeight:document.getElementById(this.guiIds.INNER_HEIGHT)},this.hideSettingsMenu(!0)},t.Class.DOMHandler.prototype.hideSettingsMenu=function(e){e?this.domElements.settingsMenu.style.visibility=this.HIDDEN:this.domElements.settingsMenu.style.visibility=this.VISIBLE},t.Class.DOMHandler.prototype.setCanvas3dResolution=function(e,t){this.domElements.canvas3d.width=e,this.domElements.canvas3d.height=t},t.Class.DOMHandler.prototype.visible=function(e){return e.style.visibility===this.VISIBLE},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.GameHandler=function(e){this.game=e,this.turnState=0,this.currentTurn=0,this.currentPlayerTurn=1,this.handsDrawn=!1},t.Class.GameHandler.prototype.update=function(){this.resolveTurns()},t.Class.GameHandler.prototype.updateAfter=function(){for(var e=0;e<this.game.players.length;e++)this.updateBattleAreaColor(this.game.players[e])},t.Class.GameHandler.prototype.updateBattleAreaColor=function(e){var n=t.CONSTANTS.P1+t.CONSTANTS.BATTLE_AREA_TYPE,i=e.battleArea.mesh;i&&(n===e.battleArea.name?i.material.diffuseColor!==e.battleArea.oriColor&&(i.material.diffuseColor=e.battleArea.oriColor):i.material.diffuseColor!==e.battleArea.oriColor&&(i.material.diffuseColor=e.battleArea.oriColor))},t.Class.GameHandler.prototype.resolveTurns=function(){this.end()||(this.turnState<=0&&this.resolveDrawHands()&&this.determineWhoFirst()&&this.resolveMulligan()&&this.incrementTurns(),this.game.turnState===this.BEGIN||this.game.turnState===this.END)},t.Class.GameHandler.prototype.resolveMulligan=function(){return!1},t.Class.GameHandler.prototype.end=function(){return!1},t.Class.GameHandler.prototype.determineWhoFirst=function(){return 1},t.Class.GameHandler.prototype.resolveDrawHands=function(){if(!this.handsDrawn){this.game.ruleHandler.addToken(this.game.players[this.game.p1].token,this.game.players[this.game.p1].battleArea),this.game.ruleHandler.addToken(this.game.players[this.game.p2].token,this.game.players[this.game.p2].battleArea);var e=this.game.players[this.game.p1].hand,t=this.game.players[this.game.p2].hand,n=this.game.players[this.game.p1].deck,i=this.game.players[this.game.p2].deck;this.game.deckHandler.shuffle(n),this.game.ruleHandler.putInHand(5,n,e,!0),this.game.ruleHandler.putInHand(5,i,t,!1),this.handsDrawn=!0}return this.handsDrawn},t.Class.GameHandler.prototype.incrementTurns=function(){this.game.turnState++},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.InputHandler=function(e){this.game=e,t.ua.touchDevice?(this.pointer=new t.Class.Touch,this.pointer.init()):(this.pointer=new t.Class.Mouse,this.pointer.init()),this.gamepad=new t.Class.Gamepad,this.gamepad.init()},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.LevelHandler=function(){this.currLevel=null},t.Class.LevelHandler.prototype.loadLevel=function(e){this.currLevel=e,this.currLevel.init()},t.Class.LevelHandler.LEVELS={LEVEL1:new t.Class.Level1,LEVEL2:new t.Class.Level2},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.RuleHandler=function(e){this.game=e},t.Class.RuleHandler.prototype.dealDamage=function(e,t,n){for(var i=0;i<t.length;i++)t[i].reduceLife(e);t[i].isDead()&&n.push(t[i])},t.Class.RuleHandler.prototype.dealLinkDamage=function(e,t){for(var n=0;n<t.length;n++)t[n].reduceLink(e)},t.Class.RuleHandler.prototype.removeToken=function(e,t){for(var n=0;n<e.length;n++)e[n].remove()},t.Class.RuleHandler.prototype.putInHand=function(e,n,i,a){for(var s=[],o=0;o<e;o++){var r=i.cards.length;s.push(i.leftPos.add(i.sizeIncrement.scale(r)));var l=this.game.deckHandler.draw(n),c=n.cards.length*t.CONSTANTS.CARD_DEPTH/2;this.game.creationHandler.createCard(l,new BABYLON.Vector3(n.mesh.position.x,n.mesh.position.y+c,n.mesh.position.z),a);for(var u=this.game.creationHandler.createDrawCardAnimation(l,s[o],i.leftRotation),d=0;d<u.length;d++)u[d].delay=.5*o,this.game.animationHandler.start(u[d]);i.cards.push(l)}},t.Class.RuleHandler.prototype.peek=function(e){},t.Class.RuleHandler.prototype.play=function(e){},t.Class.RuleHandler.prototype.addToken=function(e,n){e.name===t.CONSTANTS.P1+t.CONSTANTS.TOKEN_TYPE&&(n.tokens.push(e),e.mesh.position=n.center),e.name===t.CONSTANTS.P2+t.CONSTANTS.TOKEN_TYPE&&(n.tokens.push(e),e.mesh.position=n.center)},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.SettingsHandler=function(){this.SEPARATOR_EQ="=",this.SEPERATOR_Q="?",this.getURLParams(),this.resolution={x:0,y:0,currX:0,currY:0},this.updateResolution()},t.Class.SettingsHandler.prototype.updateResolution=function(){var e=!1;return e},t.Class.SettingsHandler.prototype.getURLParams=function(){var e=document.location.href.split(this.SEPERATOR_Q),n=1;if(e.length>n){var i=e[n].split(this.SEPARATOR_EQ);console.log(i);for(var a=0;a<i.length;a++)i[a]===t.CONSTANTS.DEBUG&&(console.log("debug"),i[a+n]===t.CONSTANTS.TRUE_STRING?t.debug=!0:t.debug=!1)}},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.StorageHandler=function(){},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Button2D=function(t,n){return this.name=t,this.context=n,this.clickable=new e._.Class.Clickable,this.pos=new BABYLON.Vector2(0,0),this.size=new BABYLON.Vector2(10,10),this},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.MessageBox=function(e,t,n){return this.name=e,this},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Gamepad=function(){this.isSupported=!1,this.pads=[]},t.Class.Gamepad.prototype.init=function(){if(!this.isInit){this.isInit=!0;var e=navigator.getGamepads||navigator.webkitGetGamepads;e&&(this.pads=e.call(navigator)),this.supportFunction=e}},t.Class.Gamepad.prototype.isAvailable=function(){return this.isInit&&this.supportFunction},t.Class.Gamepad.prototype.pollGamepads=function(){this.supportFunction&&(this.leftStick.x=0,this.leftStick.y=0,this.rightStick.x=0,this.rightStick.y=0,this.pads=this.supportFunction.call(navigator));
},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Keyboard=function(){},t.Class.Keyboard.prototype.init=function(){this.isInit||(this.isInit=!0,window.addEventListener("keydown",this.keydown.bind(this),!1),window.addEventListener("keyup",this.keyup.bind(this),!1))},t.Class.Keyboard.prototype.keydown=function(e){var t=e.target.tagName;if("INPUT"!=t&&"TEXTAREA"!=t){"keydown"==e.type?e.keyCode:2==e.button?ig.KEY.MOUSE2:ig.KEY.MOUSE1;e.stopPropagation(),e.preventDefault()}},t.Class.Keyboard.prototype.keyup=function(e){var t=e.target.tagName;if("INPUT"!=t&&"TEXTAREA"!=t){"keyup"==e.type?e.keyCode:2==e.button?ig.KEY.MOUSE2:ig.KEY.MOUSE1;e.stopPropagation(),e.preventDefault()}},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.KEYS={MOUSE1:-1,MOUSE2:-3,MWHEEL_UP:-4,MWHEEL_DOWN:-5,BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,_0:48,_1:49,_2:50,_3:51,_4:52,_5:53,_6:54,_7:55,_8:56,_9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190},t.PADKEYS={B0:0,B1:1,B2:2,B3:3,LEFT_BUMPER:4,RIGHT_BUMPER:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,BLEFT_JOYSTICK:10,BRIGHT_JOYSTICK:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,MENU:16,AXIS_X_LEFT_JOYSTICK:0,AXIS_Y_LEFT_JOYSTICK:1,AXIS_X_RIGHT_JOYSTICK:2,AXIS_Y_RIGHT_JOYSTICK:3},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Mouse=function(){this.sphere=null,this.pos=new BABYLON.Vector2.Zero,this.bindings={click:[t.KEYS.MOUSE1]},this.last=new BABYLON.Vector2.Zero},t.Class.Mouse.prototype.init=function(){if(!this.isInit){this.isInit=!0;var e=this.mousewheel.bind(this);document.addEventListener("mousewheel",e,!1),document.addEventListener("DOMMouseScroll",e,!1),document.addEventListener("contextmenu",this.contextmenu.bind(this),!1),document.addEventListener("mousedown",this.keydown.bind(this),!1),document.addEventListener("mouseup",this.keyup.bind(this),!1),document.addEventListener("mousemove",this.mousemove.bind(this),!1)}},t.Class.Mouse.prototype.mousemove=function(e){var t=e.touches?e.touches[0]:e;this.pos.x=t.clientX,this.pos.y=t.clientY},t.Class.Mouse.prototype.contextmenu=function(e){this.bindings[t.KEYS.MOUSE2]&&(e.stopPropagation(),e.preventDefault())},t.Class.Mouse.prototype.keydown=function(e){var n=e.target.tagName;if("INPUT"!=n&&"TEXTAREA"!=n){"keydown"==e.type?e.keyCode:2==e.button?t.KEYS.MOUSE2:t.KEYS.MOUSE1;"touchstart"!=e.type&&"mousedown"!=e.type||this.mousemove(e);var i=t.engine3d.scene,a=t.engine3d.engine;t.domHandler.domElements.renderWidth.innerHTML=a.getRenderWidth(),t.domHandler.domElements.renderHeight.innerHTML=a.getRenderHeight(),t.domHandler.domElements.innerWidth.innerHTML=window.innerWidth,t.domHandler.domElements.innerHeight.innerHTML=window.innerHeight;var s=i.getProjectionMatrix(),o=i.getViewMatrix(),r=i.activeCamera.getWorldMatrix(),l=i.activeCamera.viewport.toGlobal(window.innerWidth,window.innerHeight),c=l.width,u=l.height,d=BABYLON.Vector3.Unproject(new BABYLON.Vector3(this.pos.x,this.pos.y,0),c,u,r,o,s),h=BABYLON.Vector3.Unproject(new BABYLON.Vector3(this.pos.x,this.pos.y,1),c,u,r,o,s),_=h.subtract(d),A=_.y+0;_.y=-_.z,_.z=A;var p=_.normalize(),E=t.getTargetYDistance(100,i.activeCamera,p),g=i.activeCamera.position.clone().add(p.scale(E)),m=(new BABYLON.Vector3(40,40,40),1*Math.random()),C=new BABYLON.Color4(m,m,m,1);this.sphere=t.debuggerSystem.createDebugSphere(g,C),e.stopPropagation(),e.preventDefault()}},t.Class.Mouse.prototype.keyup=function(e){var n=e.target.tagName;if("INPUT"!=n&&"TEXTAREA"!=n){"keyup"==e.type?e.keyCode:2==e.button?t.KEYS.MOUSE2:t.KEYS.MOUSE1;this.sphere&&(this.sphere.dispose(),this.sphere=null),e.stopPropagation(),e.preventDefault()}},t.Class.Mouse.prototype.mousewheel=function(e){var n=e.wheelDelta?e.wheelDelta:e.detail*-1;n>0?t.KEYS.MWHEEL_UP:t.KEYS.MWHEEL_DOWN;e.stopPropagation(),e.preventDefault()},t.Class.Mouse.prototype.getLast=function(){return this.last},t.Class.Mouse.prototype.getPos=function(){var e=ig.input.mouse.x,t=ig.input.mouse.y;return this.last=new BABYLON.Vector2(e,t),this.last.clone()},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.Touch=function(){this.sphere=null,this.pos=new BABYLON.Vector2.Zero,this.last=new BABYLON.Vector2.Zero},t.Class.Touch.prototype.init=function(){this.isInit||(this.isInit=!0,navigator.maxTouchPoints&&navigator.maxTouchPoints>1&&(this.multitouchCapable=!0),window.navigator.msPointerEnabled?(document.addEventListener("MSPointerDown",this.touchDown.bind(this),!1),document.addEventListener("MSPointerUp",this.touchUp.bind(this),!1),document.addEventListener("MSPointerMove",this.touchMove.bind(this),!1),document.style.msTouchAction="none"):(document.addEventListener("touchstart",this.touchDown.bind(this),!1),document.addEventListener("touchend",this.touchUp.bind(this),!1),document.addEventListener("touchmove",this.touchMove.bind(this),!1)))},t.Class.Touch.prototype.touchDown=function(e){window.navigator.msPointerEnabled?this.touchDownWin(e):this.touchDownAndroid(e)},t.Class.Touch.prototype.touchUp=function(e){window.navigator.msPointerEnabled?this.touchUpWin(e):this.touchUpAndroid(e)},t.Class.Touch.prototype.touchMove=function(e){window.navigator.msPointerEnabled?this.touchMoveWin(e):this.touchMoveAndroid(e)},t.Class.Touch.prototype.touchDownWin=function(e){},t.Class.Touch.prototype.touchDownAndroid=function(e){var n=e.target.tagName;if("INPUT"!=n&&"TEXTAREA"!=n){"touchstart"==e.type&&this.touchMove(e);var i=t.engine3d.scene,a=t.engine3d.engine;t.domHandler.domElements.renderWidth.innerHTML=a.getRenderWidth(),t.domHandler.domElements.renderHeight.innerHTML=a.getRenderHeight(),t.domHandler.domElements.innerWidth.innerHTML=window.innerWidth,t.domHandler.domElements.innerHeight.innerHTML=window.innerHeight;var s=i.getProjectionMatrix(),o=i.getViewMatrix(),r=i.activeCamera.getWorldMatrix(),l=i.activeCamera.viewport.toGlobal(window.innerWidth,window.innerHeight),c=l.width,u=l.height,d=BABYLON.Vector3.Unproject(new BABYLON.Vector3(this.pos.x,this.pos.y,0),c,u,r,o,s),h=BABYLON.Vector3.Unproject(new BABYLON.Vector3(this.pos.x,this.pos.y,1),c,u,r,o,s),_=h.subtract(d),A=_.y+0;_.y=-_.z,_.z=A;var p=_.normalize(),E=t.getTargetYDistance(100,i.activeCamera,p),g=i.activeCamera.position.clone().add(p.scale(E)),m=1*Math.random(),C=new BABYLON.Color4(m,m,m,1);this.sphere=t.debuggerSystem.createDebugSphere(g,C);new BABYLON.Vector3(i.pointerX,100,i.pointerY);e.stopPropagation(),e.preventDefault()}},t.Class.Touch.prototype.touchMoveWin=function(e){var t=e.changedTouches?e.changedTouches:[e];this.pollMultitouch(t.length);for(var n=0;n<t.length;n++){var i=t[n],a={identifier:i.pointerId,clientX:i.clientX,clientY:i.clientY};this.upgrade(this.pressed,this.state,a),this.updateArray(this.state,a)}},t.Class.Touch.prototype.touchMoveAndroid=function(e){var t=e.touches?e.touches[0]:e;this.pos.x=t.clientX,this.pos.y=t.clientY},t.Class.Touch.prototype.touchUpWin=function(e){},t.Class.Touch.prototype.touchUpAndroid=function(e){var n=e.target.tagName;if("INPUT"!=n&&"TEXTAREA"!=n){"keyup"==e.type?e.keyCode:2==e.button?t.KEYS.MOUSE2:t.KEYS.MOUSE1;this.sphere&&(this.sphere.dispose(),this.sphere=null)}},t.Class.Touch.prototype.clear=function(){for(var e=0;e<this.released.length;++e)this.released[e]&&(this.released.splice(e,1),e--)},t.Class.Touch.prototype.pollMultitouch=function(e){this.multitouchCapable||e>1&&(this.multitouchCapable=!0)},t.Class.Touch.prototype.spliceFromArray=function(e,t){for(var n=0;n<t.length;n++)for(var i=0;i<e.length;i++)e[i].identifier===t[n].identifier&&(e.splice(i,1),i--)},t.Class.Touch.prototype.updateSizeProperties=function(){var e=parseInt(ig.system.canvas.offsetWidth)||ig.system.realWidth,t=parseInt(ig.system.canvas.offsetHeight)||ig.system.realHeight;this.scaleX=ig.system.scale*(e/ig.system.realWidth),this.scaleY=ig.system.scale*(t/ig.system.realHeight)},t.Class.Touch.prototype.upgrade=function(e,t,n){var i={left:0,top:0};ig.system.canvas.getBoundingClientRect&&(i=ig.system.canvas.getBoundingClientRect());for(var a=(n.clientX-i.left)/this.scaleX,s=(n.clientY-i.top)/this.scaleY,o=0;o<e.length;o++)if(void 0!==typeof e[o].identifier&&void 0!==typeof n.identifier&&n.identifier===e[o].identifier){e.splice(o,1),t.push({identifier:n.identifier,x:a,y:s}),o--;break}},t.Class.Touch.prototype.updateArray=function(e,t){var n={left:0,top:0};ig.system.canvas.getBoundingClientRect&&(n=ig.system.canvas.getBoundingClientRect());for(var i=(t.clientX-n.left)/this.scaleX,a=(t.clientY-n.top)/this.scaleY,s=0;s<e.length;s++)if(void 0!==typeof e[s].identifier&&void 0!==typeof t.identifier&&t.identifier===e[s].identifier){e[s].x=i,e[s].y=a;break}},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(e){GAME._unseal();var t=e._=e._||{};t.Class.VirtualJoystick=function(){this.pos=new BABYLON.Vector2(0,0),this.start=new BABYLON.Vector2(0,0),this.last=new BABYLON.Vector2(0,0),this.deltaPos=new BABYLON.Vector3(0,0,0),this.deltaVector=new BABYLON.Vector2(0,0),this.axis={x:0,y:1,z:2},this.reverseDirections=[!1,!1],this.rotationspeed=25,this.inverseRotationspeed=25,this.sensibility=25,this.inversedSensibility=25,this.deltaPosition=new BABYLON.Vector3.Zero,this.touches=[],this.rotateOnAxisRelativeToMesh=!1,this.pressed=!1,this.color="cyan",this.pointerID=-1,this.axisTarget={leftright:0,updown:1},this.identifier=null,this.drawVirtualStick=!1,this.camera=null,this.pressed=!1},t.Class.VirtualJoystick.prototype.init=function(e){this.camera=e,this.deltaPos=new BABYLON.Vector3.Zero,this.inversedSensibility=1/(this.sensibility/1e3),this.inverseRotationspeed=1/(this.rotationspeed/1e3),this.axisTarget.leftright=this.axis.x,this.axisTarget.updown=this.axis.y,this.rotateOnAxisRelativeToMesh=!1},t.Class.VirtualJoystick.prototype.initialPos=function(e){null!==this.identifier?this.identifier===e.identifier&&(this.drawVirtualStick=!0,this.start=new BABYLON.Vector2(e.x+0,e.y+0),this.pos=this.start.clone(),this.last=this.start.clone(),this.deltaVector.x=0,this.deltaVector.y=0,this.pressed=!0):(this.drawVirtualStick=!0,this.identifier=e.identifier,this.start=new BABYLON.Vector2(e.x+0,e.y+0),this.pos=this.start.clone(),this.last=this.start.clone(),this.deltaVector.x=0,this.deltaVector.y=0,this.pressed=!0)},t.Class.VirtualJoystick.prototype.updatePos=function(e){if(e.identifier===this.identifier){this.pos.x=e.x,this.pos.y=e.y,this.deltaVector=this.pos.clone(),this.deltaVector=this.deltaVector.subtract(this.start);var t=this.reverseDirections[1]?-1:1,n=t*this.deltaVector.x/this.inversedSensibility;switch(this.axisTarget.leftright){case this.axis.x:this.deltaPos.x=Math.min(1,Math.max(-1,n));break;case this.axis.y:this.deltaPos.y=Math.min(1,Math.max(-1,n));break;case this.axis.z:this.deltaPos.z=Math.min(1,Math.max(-1,n))}var i=this.reverseDirections[0]?1:-1,a=i*this.deltaVector.y/this.inversedSensibility;switch(this.axisTarget.updown){case this.axis.x:this.deltaPos.x=Math.min(1,Math.max(-1,a));break;case this.axis.y:this.deltaPos.y=Math.min(1,Math.max(-1,a));break;case this.axis.z:this.deltaPos.z=Math.min(1,Math.max(-1,a))}}this.action()},t.Class.VirtualJoystick.prototype.release=function(e,t){if("undefined"!=typeof t){if(t)return this.drawVirtualStick=!1,this.deltaVector.x=0,this.deltaVector.y=0,this.identifier=null,void(this.pressed=!1)}else e.identifier===this.identifier&&(this.drawVirtualStick=!1,this.deltaVector.x=0,this.deltaVector.y=0,this.identifier=null,this.pressed=!1)},t.Class.VirtualJoystick.prototype.action=function(){},t.Class.VirtualJoystick.prototype.debugText=function(e,t){var n=ig.system.context;n.fillStyle="rgba(255,255,0,1)",n.fillText(":"+this.deltaVector.x+" , "+this.deltaVector.y,e,t),n.fillText(":"+this.deltaPos.x+" , "+this.deltaPos.y+" , "+this.deltaPos.z,e,t+30)},t.Class.VirtualJoystick.prototype.draw=function(){var e=ig.system.context;this.drawVirtualStick&&(e.beginPath(),e.lineWidth=6,e.strokeStyle=this.color,e.arc(this.start.x,this.start.y,40,0,2*Math.PI,!0),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=2,e.arc(this.start.x,this.start.y,60,0,2*Math.PI,!0),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle=this.color,e.arc(this.pos.x,this.pos.y,40,0,2*Math.PI,!0),e.stroke(),e.closePath())},t.Class.VirtualJoystick.prototype.setSensibility=function(e){this.sensibility=e,this.inversedSensibility=1/(this.sensibility/1e3)},GAME._seal(),GAME._seal=e._seal=e._seal||function(){delete e._,delete e._seal,delete e._unseal},GAME._unseal=e._unseal=e._unseal||function(){e._=t,e._seal=e._seal,e._unseal=e._unseal}}(GAME),function(){GAME._seal()}();